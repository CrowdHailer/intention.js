<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <script src="./intention.js"></script>
  <script src="https://npmcdn.com/axios/dist/axios.min.js"></script>
  <title>Client Test</title>
</head>
<body>
  <h1>hello</h1>
  <form>
    <input type="email" name="email">
    <button type="submit">signup</button>
  </form>
  <script type="text/javascript">
    console.log('hello')
    var log = window.console.log.bind(window.console)

    function parseJSON (response) {
      if (response.ok) {
        return response.json()
      } else {
        throw new Error(response.status)
      }
    }

    function encodeFormData (data) {
      var urlEncodedData = "";
      var urlEncodedDataPairs = [];
      var name;

      // We turn the data object into an array of URL encoded key value pairs.
      for(name in data) {
        urlEncodedDataPairs.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
      }

      // We combine the pairs into a single string and replace all encoded spaces to
      // the plus character to match the behaviour of the web browser form submit.
      urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');
      return urlEncodedData
    }

    var Passports = {
      create: function (data) {
        return Intention.fetch('http://api.goodoverlord.com/api/passport', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data),
        }).then(parseJSON).then(function (entity) {return entity.data})
      }
    }

    var Auth = {
      token: function (authority) {
        return Intention.fetch('http://api.goodoverlord.com/api/oauth/token', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json'},
          body: encodeFormData({
            username: authority.email,
            password: authority.password,
            grant_type: 'password'
          })
        }).then(parseJSON)
      }
    }

    var $form = document.querySelector('form')
    var $email = document.querySelector('[name=email]')
    $form.addEventListener('submit', function (evt) {
      evt.preventDefault()
      var email = $email.value
      Passports.create({email: email, name: 'test', password: 'password'}).then(function (json) {
        console.log(json)
        var body = encodeFormData({
          username: email,
          password: 'password',
          grant_type: 'password'
        })
        return Intention.fetch('http://api.goodoverlord.com/api/oauth/token', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json'},
          body: body
        }).then(parseJSON)
      }).then(log).run(window)
    }, false)
  </script>
  <script src="./test.js"></script>
  <script type="text/javascript">
    function liveTest (fixture) {
      var email = fixture.email;

      (function () {
        // Move passport creation to setup or serialise testing.
        var action = Passports.create({email: email, name: 'test', password: 'password'})
        action.run(window).then(function (passport) {
          console.log(passport)
          console.info(passport.name === 'test', 'correct passport name');
          console.info(passport.email === email, 'correct passport email');
          console.info(passport.id.length > 0, 'passport has id');
        }).then(function () {
          return Auth.token({email: email, password: 'password'}).run(window)
        }).then(function (credentials) {
          console.log(credentials)
          return credentials
        }).then(function (credentials) {
          
        });
      }());

    }
  </script>
</body>
</html>
